# NetVis Pro 企业级平台 - 完整设计方案

## 一、业务场景定位

### 目标客户

**中大型数据中心** - 500~10,000+ 台网络设备

### 核心需求

| 维度     | 要求               |
| -------- | ------------------ |
| 设备监控 | 10 秒级采集频率    |
| 数据量   | 日均数亿时序数据点 |
| 可用性   | 99.9%+             |
| 告警响应 | 秒级检测推送       |

---

## 二、技术架构选型

### 整体架构

```
┌──────────────────────────────────────────────────────────────┐
│                         Nginx                                 │
└─────────────────────────────┬────────────────────────────────┘
          ┌───────────────────┼───────────────────┐
          ▼                   ▼                   ▼
   ┌────────────┐      ┌────────────┐      ┌────────────┐
   │  前端 SPA  │      │  Bun API   │      │  Go采集器  │
   │  React     │      │  Hono      │      │  告警引擎  │
   └────────────┘      └────────────┘      └────────────┘
                              │                   │
                       ┌──────┴──────┐            │
                       ▼             ▼            ▼
               ┌───────────┐  ┌───────────┐  ┌───────────┐
               │PostgreSQL │  │   Redis   │  │TimescaleDB│
               └───────────┘  └───────────┘  └───────────┘
```

### 技术选型

| 层级     | 技术                      | 职责                |
| -------- | ------------------------- | ------------------- |
| 前端     | React + Vite + Ant Design | 现有技术栈保持      |
| 业务 API | Bun + Hono                | 用户/资产/配置 CRUD |
| 采集层   | Go + gosnmp               | SNMP 轮询、指标采集 |
| 告警引擎 | Go + NATS                 | 规则匹配、通知分发  |
| 主数据库 | PostgreSQL                | 用户/资产/配置      |
| 时序库   | TimescaleDB               | 监控指标历史        |
| 缓存     | Redis                     | 会话/实时状态/队列  |

---

## 2.3、License 授权体系

> [!IMPORTANT]
> 模块化设计 + License 控制 = 灵活的商业化运营能力

### 授权维度

| 维度         | 控制项       | 示例               |
| ------------ | ------------ | ------------------ |
| **功能模块** | 按模块激活   | 基础版不含配置管理 |
| **设备点数** | 管理设备上限 | 100/500/1000/无限  |
| **用户数**   | 并发用户上限 | 5/20/50/无限       |
| **有效期**   | 授权时长     | 1 年/3 年/永久     |
| **高可用**   | 灾备功能     | 企业版专属         |

### 功能模块划分

| 模块代码 | 模块名称          |  基础版  | 专业版  | 企业版  |
| -------- | ----------------- | :------: | :-----: | :-----: |
| CORE     | 仪表盘+拓扑可视化 |    ✅    |   ✅    |   ✅    |
| ASSET    | 资产管理          |    ✅    |   ✅    |   ✅    |
| ALERT    | 告警管理          | ⚠️ 基础  | ✅ 完整 | ✅ 完整 |
| SSH      | SSH 设备管理      |    ❌    |   ✅    |   ✅    |
| CONFIG   | 配置备份/下发     |    ❌    |   ✅    |   ✅    |
| REPORT   | 报表中心          |    ❌    |   ✅    |   ✅    |
| AUDIT    | 审计日志          | ⚠️ 30 天 | ✅ 1 年 | ✅ 永久 |
| HA       | 多活灾备          |    ❌    |   ❌    |   ✅    |
| MOBILE   | 移动端/企微       |    ❌    |   ❌    |   ✅    |
| API      | 开放 API          |    ❌    | ⚠️ 限流 | ✅ 无限 |

### License 技术实现

#### License 文件格式

```json
{
  "license_id": "NV-2024-XXXX-XXXX",
  "customer": "XX数据中心",
  "edition": "enterprise",
  "modules": [
    "CORE",
    "ASSET",
    "ALERT",
    "SSH",
    "CONFIG",
    "REPORT",
    "AUDIT",
    "HA",
    "MOBILE",
    "API"
  ],
  "limits": {
    "max_devices": 5000,
    "max_users": 100,
    "expire_at": "2026-12-31"
  },
  "signature": "RSA签名防篡改"
}
```

#### 验证流程

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│ 导入License │ ──► │ RSA验签     │ ──► │ 存入数据库  │
└─────────────┘     └─────────────┘     └─────────────┘
                                               │
┌─────────────────────────────────────────────┼─────────┐
│                   运行时校验                 ▼         │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐│
│  │ 模块加载时  │    │ 设备新增时  │    │ 用户登录时  ││
│  │ 检查MODULE │    │ 检查点数   │    │ 检查并发   ││
│  └─────────────┘    └─────────────┘    └─────────────┘│
└───────────────────────────────────────────────────────┘
```

#### 后端 API

| API                      | 功能              |
| ------------------------ | ----------------- |
| POST /api/license/import | 导入 License 文件 |
| GET /api/license/info    | 查询当前授权信息  |
| GET /api/license/usage   | 查询使用量统计    |
| GET /api/license/modules | 查询已激活模块    |

#### 前端实现

| 位置      | 控制逻辑                     |
| --------- | ---------------------------- |
| 路由守卫  | 未授权模块跳转到升级页       |
| 菜单渲染  | 未授权模块隐藏或置灰         |
| 按钮/操作 | 检查模块权限，无权限弹窗提示 |
| 设备新增  | 检查点数，超限阻止操作       |

#### 超限处理

| 场景         | 处理方式                 |
| ------------ | ------------------------ |
| 设备超限     | 阻止新增，提示升级       |
| 用户超限     | 新用户无法登录，提示     |
| 模块未授权   | 菜单隐藏/置灰 + 升级引导 |
| License 过期 | 只读模式，保留数据查看   |

---

## 2.4、统一开放 API

> [!TIP]
> 面向二次开发、第三方系统集成、自动化运维的标准化接口

### API 分类

| 类别         | 面向对象        | 认证方式            | 权限控制   |
| ------------ | --------------- | ------------------- | ---------- |
| **管理 API** | 平台管理员      | API Key + IP 白名单 | 全量权限   |
| **业务 API** | 普通用户/第三方 | OAuth2.0 / JWT      | 按角色限制 |
| **Webhook**  | 外部系统        | 签名校验            | 仅推送     |

### 管理 API（Admin）

#### 用户与权限

| 方法   | 路径                 | 功能     |
| ------ | -------------------- | -------- |
| GET    | /api/admin/users     | 用户列表 |
| POST   | /api/admin/users     | 创建用户 |
| PUT    | /api/admin/users/:id | 更新用户 |
| DELETE | /api/admin/users/:id | 删除用户 |
| GET    | /api/admin/roles     | 角色列表 |
| POST   | /api/admin/roles     | 创建角色 |

#### License 管理

| 方法 | 路径                      | 功能     |
| ---- | ------------------------- | -------- |
| POST | /api/admin/license/import | 导入授权 |
| GET  | /api/admin/license/info   | 授权信息 |
| GET  | /api/admin/license/usage  | 使用统计 |

#### 系统配置

| 方法 | 路径                  | 功能         |
| ---- | --------------------- | ------------ |
| GET  | /api/admin/settings   | 获取系统配置 |
| PUT  | /api/admin/settings   | 更新系统配置 |
| GET  | /api/admin/audit-logs | 审计日志查询 |
| POST | /api/admin/backup     | 触发数据备份 |

### 业务 API（Business）

#### 设备资产

| 方法   | 路径                     | 功能         |
| ------ | ------------------------ | ------------ |
| GET    | /api/devices             | 设备列表     |
| GET    | /api/devices/:id         | 设备详情     |
| POST   | /api/devices             | 新增设备     |
| PUT    | /api/devices/:id         | 更新设备     |
| DELETE | /api/devices/:id         | 删除设备     |
| GET    | /api/devices/:id/metrics | 设备指标历史 |
| GET    | /api/devices/:id/config  | 设备配置     |
| GET    | /api/device-groups       | 设备分组     |

#### 拓扑数据

| 方法 | 路径                    | 功能         |
| ---- | ----------------------- | ------------ |
| GET  | /api/topology/nodes     | 拓扑节点     |
| GET  | /api/topology/links     | 拓扑连线     |
| GET  | /api/topology/full      | 完整拓扑数据 |
| POST | /api/topology/discovery | 触发拓扑发现 |

#### 告警管理

| 方法 | 路径                    | 功能     |
| ---- | ----------------------- | -------- |
| GET  | /api/alerts             | 告警列表 |
| GET  | /api/alerts/:id         | 告警详情 |
| PUT  | /api/alerts/:id/ack     | 确认告警 |
| PUT  | /api/alerts/:id/resolve | 解决告警 |
| GET  | /api/alert-rules        | 告警规则 |
| POST | /api/alert-rules        | 创建规则 |

#### 报表数据

| 方法 | 路径                       | 功能         |
| ---- | -------------------------- | ------------ |
| GET  | /api/reports/device-health | 设备健康报表 |
| GET  | /api/reports/alert-stats   | 告警统计报表 |
| GET  | /api/reports/traffic-trend | 流量趋势报表 |
| POST | /api/reports/export        | 报表导出     |

### Webhook 推送

#### 事件类型

| 事件            | 触发条件 | 推送内容           |
| --------------- | -------- | ------------------ |
| device.online   | 设备上线 | 设备 ID、IP、时间  |
| device.offline  | 设备离线 | 设备 ID、IP、时间  |
| alert.triggered | 告警触发 | 告警详情           |
| alert.resolved  | 告警解决 | 告警 ID、处理人    |
| config.changed  | 配置变更 | 设备 ID、变更 diff |

#### Webhook 配置

```json
{
  "url": "https://your-system.com/webhook",
  "secret": "用于签名校验",
  "events": ["alert.triggered", "device.offline"],
  "retry": 3
}
```

### API 安全与规范

#### 认证方式

| 方式     | 适用场景   | Header                      |
| -------- | ---------- | --------------------------- |
| API Key  | 服务端对接 | `X-API-Key: xxx`            |
| JWT      | 用户会话   | `Authorization: Bearer xxx` |
| OAuth2.0 | 第三方应用 | 标准 OAuth 流程             |

#### 限流策略

| 版本   | 限制         |
| ------ | ------------ |
| 基础版 | 无 API 访问  |
| 专业版 | 1000 次/分钟 |
| 企业版 | 无限制       |

#### 响应格式

```json
{
  "code": 0,
  "message": "success",
  "data": { ... },
  "timestamp": 1702483200
}
```

#### 错误码

| 代码 | 含义                |
| ---- | ------------------- |
| 0    | 成功                |
| 401  | 未认证              |
| 403  | 无权限/License 受限 |
| 404  | 资源不存在          |
| 429  | 请求过频            |
| 500  | 服务器错误          |

### API 文档

- **Swagger/OpenAPI 3.0** 自动生成
- 内置交互式调试控制台
- SDK 生成（TypeScript/Go/Java）

---

## 2.5、多活冗余灾备架构

### 部署拓扑

```
┌─────────────────────────────────────────────────────────────────────┐
│                        全局负载均衡 (DNS/GSLB)                        │
└─────────────────────────────┬───────────────────────────────────────┘
              ┌───────────────┴───────────────┐
              ▼                               ▼
┌─────────────────────────┐       ┌─────────────────────────┐
│      主站点 (Site A)     │       │     灾备站点 (Site B)    │
│  ┌─────────────────────┐│       │┌─────────────────────┐  │
│  │ Nginx + Keepalived  ││◄─────►││ Nginx + Keepalived  │  │
│  └─────────────────────┘│       │└─────────────────────┘  │
│  ┌────────┐ ┌────────┐  │       │ ┌────────┐ ┌────────┐  │
│  │Bun API │ │Bun API │  │       │ │Bun API │ │Bun API │  │
│  │  (x2)  │ │  (x2)  │  │       │ │  (x2)  │ │  (x2)  │  │
│  └────────┘ └────────┘  │       │ └────────┘ └────────┘  │
│  ┌────────┐ ┌────────┐  │       │ ┌────────┐ ┌────────┐  │
│  │Go采集器│ │Go告警  │  │       │ │Go采集器│ │Go告警  │  │
│  │  (x2)  │ │  (x2)  │  │       │ │  (x2)  │ │  (x2)  │  │
│  └────────┘ └────────┘  │       │ └────────┘ └────────┘  │
└─────────────────────────┘       └─────────────────────────┘
              │                               │
              ▼                               ▼
┌─────────────────────────┐       ┌─────────────────────────┐
│  PostgreSQL Primary     │──────►│  PostgreSQL Standby     │
│  (流复制)               │       │  (热备自动切换)          │
└─────────────────────────┘       └─────────────────────────┘
              │                               │
┌─────────────────────────┐       ┌─────────────────────────┐
│  Redis Sentinel (x3)    │◄─────►│  Redis Sentinel (x3)   │
└─────────────────────────┘       └─────────────────────────┘
```

### 高可用组件

| 组件            | 方案                 | 说明                         |
| --------------- | -------------------- | ---------------------------- |
| **负载均衡**    | Nginx + Keepalived   | VIP 漂移，秒级故障切换       |
| **API 服务**    | 多副本 + 无状态      | 水平扩展，任意节点可处理请求 |
| **PostgreSQL**  | 主从流复制 + Patroni | 自动故障检测与主从切换       |
| **TimescaleDB** | 主从复制             | 与 PG 相同方案               |
| **Redis**       | Sentinel 哨兵模式    | 自动主从切换                 |
| **NATS**        | 集群模式(3 节点)     | 消息持久化 + 自动重连        |

### 灾备切换策略

| 场景           | RTO     | RPO    | 切换方式                    |
| -------------- | ------- | ------ | --------------------------- |
| 单服务故障     | <10 秒  | 0      | 自动（负载均衡剔除）        |
| 单节点宕机     | <30 秒  | 0      | 自动（Keepalived VIP 漂移） |
| 数据库主库故障 | <60 秒  | <1 秒  | 自动（Patroni 切换）        |
| 整站故障       | <5 分钟 | <10 秒 | 手动 DNS 切换 或 GSLB 自动  |

### 数据同步

- **同步复制**：PostgreSQL synchronous_commit 确保零数据丢失
- **异步复制**：TimescaleDB 降级为异步，优先保证写入性能
- **会话同步**：Redis Sentinel 跨机房复制

---

## 三、多厂商设备管理体系

> [!IMPORTANT]
> 对标华为 iMaster NCE、思科 DNA Center、锐捷 RIIL 等企业级统一管理平台

### 支持厂商列表

| 厂商             | 设备类型             | 协议支持                  |
| ---------------- | -------------------- | ------------------------- |
| **Cisco**        | IOS/IOS-XE/NX-OS/ACI | SSH/SNMP/NETCONF/RESTCONF |
| **Huawei**       | VRP/CloudEngine      | SSH/SNMP/NETCONF          |
| **H3C**          | Comware              | SSH/SNMP/NETCONF          |
| **Ruijie**       | RGOS                 | SSH/SNMP                  |
| **Nokia**        | SR OS                | SSH/SNMP/NETCONF          |
| **Juniper**      | Junos                | SSH/SNMP/NETCONF          |
| **Arista**       | EOS                  | SSH/SNMP/eAPI             |
| **Dell/Force10** | OS10                 | SSH/SNMP                  |
| **Fortinet**     | FortiOS              | SSH/API                   |
| **Palo Alto**    | PAN-OS               | SSH/API                   |

### SSH 设备管理模块

#### 技术架构

```
┌──────────────────────────────────────────────────────────────┐
│                    Go SSH Gateway                             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐           │
│  │ SSH Client  │  │  Expect库   │  │ 命令解析器  │           │
│  │  (golang/x) │  │  (多厂商)   │  │  (TextFSM)  │           │
│  └─────────────┘  └─────────────┘  └─────────────┘           │
│                         │                                     │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │              厂商适配层 (Vendor Adapters)                │ │
│  │  ┌───────┐ ┌───────┐ ┌───────┐ ┌───────┐ ┌───────┐     │ │
│  │  │ Cisco │ │Huawei │ │  H3C  │ │Ruijie │ │Juniper│     │ │
│  │  └───────┘ └───────┘ └───────┘ └───────┘ └───────┘     │ │
│  └─────────────────────────────────────────────────────────┘ │
└──────────────────────────────────────────────────────────────┘
```

#### 核心功能

| 功能模块     | 描述                                      |
| ------------ | ----------------------------------------- |
| **凭据管理** | 加密存储 SSH 用户名/密码/密钥，支持凭据组 |
| **命令模板** | 预置各厂商常用命令（show 版本/接口/路由） |
| **批量执行** | 多设备并发执行命令，结果汇总              |
| **脚本编排** | 可视化拖拽编排多步骤任务                  |
| **审批流程** | 高危命令需审批后执行                      |
| **执行日志** | 完整记录输入输出，支持回放                |

#### 采集信息清单

| 分类         | 采集项                               |
| ------------ | ------------------------------------ |
| **基础信息** | 设备型号、序列号、软件版本、运行时长 |
| **接口状态** | 端口列表、UP/DOWN、速率、双工、错包  |
| **路由表**   | 静态/动态路由条目、下一跳、出接口    |
| **ARP/MAC**  | ARP 表、MAC 地址表、VLAN 对应        |
| **CPU/内存** | 实时负载、历史趋势                   |
| **配置备份** | Running-config 定时备份、版本对比    |
| **日志收集** | Syslog、告警 Events                  |

### SNMP 采集增强

#### 支持版本

- SNMP v1/v2c（团体名认证）
- SNMP v3（用户名+加密+认证）

#### 标准 MIB 支持

| MIB                | 用途                       |
| ------------------ | -------------------------- |
| IF-MIB             | 接口流量、状态、错误计数   |
| HOST-RESOURCES-MIB | CPU、内存、磁盘            |
| ENTITY-MIB         | 硬件实体（机框/板卡/电源） |
| IP-MIB             | IP 地址、路由表            |
| BGP4-MIB           | BGP 邻居状态               |
| OSPF-MIB           | OSPF 邻居、区域            |

#### 私有 MIB 支持

- Cisco: CISCO-PROCESS-MIB, CISCO-ENVMON-MIB
- Huawei: HUAWEI-ENTITY-EXTENT-MIB
- H3C: HH3C-ENTITY-EXT-MIB

### NETCONF/YANG 支持

#### 技术实现

```
┌────────────────────────────────────────┐
│           Go NETCONF Client            │
│  ┌──────────────┐  ┌────────────────┐  │
│  │ yang.go解析  │  │ netconf库     │  │
│  └──────────────┘  └────────────────┘  │
└────────────────────────────────────────┘
```

#### 能力

| 操作        | 描述          |
| ----------- | ------------- |
| GET         | 获取配置/状态 |
| GET-CONFIG  | 获取配置数据  |
| EDIT-CONFIG | 修改配置      |
| SUBSCRIBE   | 事件订阅      |

### 配置管理功能

#### 配置备份

| 功能     | 描述                             |
| -------- | -------------------------------- |
| 定时备份 | 每日/每周自动采集 running-config |
| 手动备份 | 一键触发即时备份                 |
| 版本管理 | Git 式版本历史，任意版本回滚     |
| 配置对比 | Diff 视图高亮变更行              |

#### 配置下发

| 功能     | 描述                         |
| -------- | ---------------------------- |
| 模板引擎 | Jinja2 模板 + 变量替换       |
| 预览验证 | 下发前模拟解析，避免语法错误 |
| 分批下发 | 按分组逐批执行，失败回滚     |
| 合规检查 | 配置基线对比，偏离告警       |

### 网络发现与拓扑自动生成

#### 发现协议

| 协议          | 用途                   |
| ------------- | ---------------------- |
| CDP/LLDP      | 邻居发现，自动绘制链路 |
| ARP/MAC       | IP-MAC 对应，定位终端  |
| ICMP Ping     | 存活检测               |
| TCP Port Scan | 服务探测               |

#### 拓扑自动生成

```mermaid
flowchart LR
    A[种子设备] --> B[SNMP发现邻居]
    B --> C[递归遍历]
    C --> D[去重合并]
    D --> E[生成拓扑数据]
    E --> F[3D/2D渲染]
```

### 对标厂商功能矩阵

| 功能       | 华为 iMaster | 思科 DNA | 本平台    |
| ---------- | ------------ | -------- | --------- |
| 设备发现   | ✅           | ✅       | ✅ 规划   |
| 拓扑可视化 | ✅           | ✅       | ✅ 已实现 |
| 配置管理   | ✅           | ✅       | ✅ 规划   |
| 告警管理   | ✅           | ✅       | ✅ 规划   |
| 流量分析   | ✅           | ✅       | ✅ 规划   |
| 性能监控   | ✅           | ✅       | ✅ 规划   |
| 合规审计   | ✅           | ✅       | ✅ 规划   |
| 批量运维   | ✅           | ✅       | ✅ 规划   |
| 多租户     | ✅           | ✅       | 📋 待定   |
| SD-WAN     | ✅           | ✅       | 📋 未来   |

---

## 四、功能路线图

### Phase 1：后端基建 + 用户权限（2 周）

#### 前端任务

| 功能       | 描述                |
| ---------- | ------------------- |
| 登录页     | 账号密码 + 验证码   |
| 路由守卫   | 未登录跳转          |
| 用户管理页 | CRUD 表格           |
| 权限上下文 | 按角色显隐菜单/按钮 |

#### 后端任务（Bun/Hono）

| 功能       | API                    |
| ---------- | ---------------------- |
| 登录认证   | POST /api/auth/login   |
| Token 刷新 | POST /api/auth/refresh |
| 用户 CRUD  | /api/users             |
| 角色管理   | /api/roles             |
| 审计日志   | /api/audit-logs        |

#### 数据库表

```sql
-- users, roles, permissions, audit_logs
```

---

### Phase 2：告警通知系统（2 周）

#### 前端任务

| 功能            | 描述                |
| --------------- | ------------------- |
| 告警中心页      | 列表+筛选+批量确认  |
| 告警规则配置    | 阈值/状态/组合规则  |
| 通知渠道配置    | 邮件/企微/钉钉/短信 |
| Header 告警铃铛 | 未读数+弹窗列表     |

#### 后端任务

| 服务     | 技术 | API/功能           |
| -------- | ---- | ------------------ |
| 规则引擎 | Go   | 阈值检测、状态监测 |
| 通知服务 | Go   | Webhook/SMTP/SMS   |
| 告警 API | Bun  | /api/alerts CRUD   |
| 规则 API | Bun  | /api/alert-rules   |

#### 告警生命周期

```
触发 → 待处理 → 处理中 → 已解决
```

---

### Phase 3：资产全生命周期（2 周）

#### 前端任务

| 功能              | 描述                   |
| ----------------- | ---------------------- |
| 设备详情抽屉      | 基础信息/端口/历史曲线 |
| 设备新增/编辑表单 | 字段校验               |
| 资产分组页        | 按机房/机柜/业务线     |
| SNMP 发现向导     | 网段扫描 + 批量导入    |

#### 后端任务

| 功能      | API                      |
| --------- | ------------------------ |
| 设备 CRUD | /api/devices             |
| 分组管理  | /api/device-groups       |
| SNMP 发现 | Go 服务，/api/discovery  |
| 变更历史  | /api/devices/:id/history |

---

### Phase 4：数据分析报表（1.5 周）

#### 前端任务

| 功能       | 描述                     |
| ---------- | ------------------------ |
| 趋势图组件 | 7 天/30 天 CPU/流量/内存 |
| 报表中心页 | 健康评分/告警时效/利用率 |
| 数据导出   | Excel/PDF 下载           |

#### 后端任务

| 功能     | 技术              |
| -------- | ----------------- |
| 时序查询 | TimescaleDB 聚合  |
| 报表 API | /api/reports      |
| 定时报表 | Go CronJob + 邮件 |

---

### Phase 5：UI/UX 增强（1 周）

#### 功能清单

| 功能         | 描述               |
| ------------ | ------------------ |
| 大屏模式     | 全屏轮播 Dashboard |
| 仪表盘自定义 | 卡片拖拽排序       |
| 拓扑导出     | PNG/SVG            |
| 中英文切换   | i18n               |
| 移动端适配   | 响应式布局         |

---

## 四、数据库设计概览

### PostgreSQL 主库

- `users` / `roles` / `permissions`
- `devices` / `device_groups` / `device_history`
- `alerts` / `alert_rules` / `notification_channels`
- `audit_logs`

### TimescaleDB 时序库

- `device_metrics` (device_id, timestamp, cpu, memory, traffic...)

### Redis

- 会话 Token
- 实时设备状态
- 告警队列

---

## 五、移动端规划（预留）

> [!NOTE]
> 本阶段仅做架构预备，不开发 App

### 移动端形态

| 形态           | 技术方案      | 入口             |
| -------------- | ------------- | ---------------- |
| 企业微信工作台 | H5 自适应页面 | 企微应用菜单     |
| 独立 App       | Flutter       | iOS/Android 双端 |

### 企业微信集成准备

#### API 对接

```
后端预留接口：
POST /api/wechat/auth     # 企微扫码登录
GET  /api/wechat/jsconfig # JS-SDK签名
POST /api/wechat/notify   # 告警推送到企微
```

#### 企微工作台应用配置

- 可信域名绑定
- OAuth2.0 授权回调
- 消息模板申请

#### H5 适配清单

| 页面           | 功能                    |
| -------------- | ----------------------- |
| 移动 Dashboard | 核心指标卡片 + 告警计数 |
| 告警列表       | 下拉刷新 + 快捷确认     |
| 设备搜索       | 搜索 + 基础状态展示     |
| 告警详情       | 查看 + 确认 + 备注      |

### Flutter App 预留

#### 技术架构

```
┌─────────────────────────────────────┐
│          Flutter App                │
│  ┌───────────┐  ┌───────────────┐   │
│  │  Riverpod │  │  Dio HTTP     │   │
│  │  状态管理  │  │  网络请求    │   │
│  └───────────┘  └───────────────┘   │
│  ┌───────────────────────────────┐  │
│  │      统一 API Client          │  │
│  │  (与 Web 共用 REST API)       │  │
│  └───────────────────────────────┘  │
└─────────────────────────────────────┘
              │
              ▼
┌─────────────────────────────────────┐
│       Bun/Hono 后端 API             │
│  (同一套接口，无需额外开发)          │
└─────────────────────────────────────┘
```

#### 后端 API 设计规范（兼容移动端）

| 规范       | 说明                         |
| ---------- | ---------------------------- |
| RESTful    | 标准 HTTP 状态码 + JSON 响应 |
| 分页       | 统一 `page/pageSize` 参数    |
| Token 认证 | Bearer JWT，支持刷新         |
| 响应压缩   | gzip/brotli                  |
| 离线支持   | 关键数据支持 ETag 缓存       |

#### App 功能规划（未来开发）

| 模块 | 功能                      |
| ---- | ------------------------- |
| 首页 | 实时 Dashboard + 告警概览 |
| 告警 | 列表/详情/确认/转派       |
| 设备 | 搜索/详情/手电筒扫码定位  |
| 通知 | 推送接收 + 消息中心       |
| 我的 | 值班表/个人设置/退出      |

---

## 七、DevOps 与运维架构

> [!TIP]
> 降低乙方运维压力 = 快速部署 + 高效排错 + 平滑升级

### 一键部署方案

#### 部署包结构

```
netvis-pro-v1.0.0/
├── docker-compose.yml        # 服务编排
├── .env.example              # 环境变量模板
├── init-db.sql               # 数据库初始化脚本
├── config/
│   ├── nginx.conf            # 反向代理配置
│   └── app.yaml              # 应用配置模板
├── scripts/
│   ├── install.sh            # 一键安装脚本
│   ├── upgrade.sh            # 一键升级脚本
│   ├── backup.sh             # 数据备份脚本
│   └── health-check.sh       # 健康检查脚本
└── docs/
    ├── INSTALL.md            # 安装文档
    ├── UPGRADE.md            # 升级文档
    └── TROUBLESHOOTING.md    # 故障排查手册
```

#### 安装流程

```bash
# 1. 解压部署包
tar -xzf netvis-pro-v1.0.0.tar.gz && cd netvis-pro

# 2. 复制并编辑配置
cp .env.example .env && vim .env

# 3. 一键启动（自动拉取镜像、初始化数据库）
./scripts/install.sh

# 4. 访问 http://IP:8080
```

### 可观测性体系

#### 日志管理

| 组件      | 日志位置                      | 采集方式    |
| --------- | ----------------------------- | ----------- |
| 前端      | 浏览器控制台                  | Sentry 上报 |
| Bun API   | /var/log/netvis/api.log       | JSON 格式   |
| Go 采集器 | /var/log/netvis/collector.log | JSON 格式   |
| Nginx     | /var/log/nginx/access.log     | 标准格式    |

#### 日志规范

```json
{
  "time": "2024-12-13T23:00:00Z",
  "level": "ERROR",
  "service": "api",
  "trace_id": "abc123",
  "user_id": "u001",
  "message": "Device connection failed",
  "error": "timeout",
  "device_id": "d001"
}
```

#### 指标监控

| 指标         | 采集方式      | 告警阈值      |
| ------------ | ------------- | ------------- |
| API 响应时间 | Prometheus    | P95 > 500ms   |
| 服务存活     | HTTP 健康检查 | 连续 3 次失败 |
| CPU/内存     | cAdvisor      | > 80%         |
| 磁盘空间     | Node Exporter | > 90%         |
| 连接池       | 应用内埋点    | 使用率 > 80%  |

#### 监控大盘

```
┌─────────────────────────────────────────────────────────────┐
│                    Grafana Dashboard                         │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐          │
│  │ 服务状态    │  │ API延迟     │  │ 错误率     │          │
│  └─────────────┘  └─────────────┘  └─────────────┘          │
│  ┌─────────────────────────────────────────────────┐        │
│  │              请求量趋势图                        │        │
│  └─────────────────────────────────────────────────┘        │
└─────────────────────────────────────────────────────────────┘
```

### 排错工具箱

#### 内置诊断接口

| 路径              | 功能                 |
| ----------------- | -------------------- |
| GET /health       | 服务健康状态         |
| GET /health/db    | 数据库连接状态       |
| GET /health/redis | Redis 连接状态       |
| GET /metrics      | Prometheus 指标      |
| GET /debug/vars   | 运行时变量（仅内网） |

#### 健康检查响应

```json
{
  "status": "healthy",
  "version": "1.0.0",
  "uptime": "3d 5h 20m",
  "checks": {
    "database": "ok",
    "redis": "ok",
    "collector": "ok"
  }
}
```

#### 故障排查手册

| 现象       | 可能原因         | 排查步骤                    |
| ---------- | ---------------- | --------------------------- |
| 页面白屏   | 前端资源加载失败 | 检查 Nginx 配置、CDN        |
| API 502    | 后端服务挂掉     | 检查容器状态、日志          |
| 设备不更新 | 采集器异常       | 检查 Go 容器、SNMP 连通性   |
| 登录失败   | Redis/JWT 问题   | 检查 Redis 连接、Token 配置 |

### 版本升级方案

#### 升级策略

| 升级类型         | 停机时间   | 回滚方式 |
| ---------------- | ---------- | -------- |
| 补丁版本 (1.0.x) | 0          | 自动回滚 |
| 次版本 (1.x.0)   | < 1 分钟   | 手动回滚 |
| 主版本 (x.0.0)   | 按迁移脚本 | 备份恢复 |

#### 升级流程

```bash
# 1. 备份数据
./scripts/backup.sh

# 2. 拉取新版本镜像
docker-compose pull

# 3. 执行数据库迁移
./scripts/migrate.sh

# 4. 滚动重启服务
docker-compose up -d --no-deps api collector

# 5. 验证健康状态
./scripts/health-check.sh
```

#### 数据库迁移

```
migrations/
├── 001_init_schema.sql
├── 002_add_audit_logs.sql
├── 003_add_license_table.sql
└── ...
```

- 使用 **golang-migrate** 或 **Bun 内置迁移**
- 每次升级自动执行 pending 迁移
- 支持回滚（down migration）

### 配置管理

#### 配置分层

| 层级     | 来源            | 优先级 |
| -------- | --------------- | ------ |
| 默认值   | 代码内置        | 最低   |
| 配置文件 | config/app.yaml | 中     |
| 环境变量 | .env 或 Docker  | 最高   |

#### 环境变量清单

```bash
# 数据库
DB_HOST=localhost
DB_PORT=5432
DB_USER=netvis
DB_PASSWORD=xxx
DB_NAME=netvis

# Redis
REDIS_URL=redis://localhost:6379

# JWT
JWT_SECRET=xxx
JWT_EXPIRE=24h

# 日志
LOG_LEVEL=info
LOG_FORMAT=json

# License
LICENSE_PUBLIC_KEY=xxx
```

#### 配置热更新

- 支持配置热加载（无需重启）
- 告警规则、通知渠道等运行时配置
- 通过 API 或 Web 界面修改

### 备份与恢复

#### 自动备份策略

| 数据       | 频率     | 保留      |
| ---------- | -------- | --------- |
| PostgreSQL | 每日凌晨 | 7 天      |
| 配置文件   | 变更时   | 永久(Git) |
| 设备配置   | 每日     | 30 天     |

#### 恢复流程

```bash
# 1. 停止服务
docker-compose stop

# 2. 恢复数据库
pg_restore -U netvis -d netvis backup.sql

# 3. 恢复配置
cp -r backup/config ./config

# 4. 启动服务
docker-compose up -d
```

### 模块化容器架构

```yaml
# docker-compose.yml
services:
  # 核心服务（必需）
  frontend:
    image: netvis/frontend:${VERSION}
  api:
    image: netvis/api:${VERSION}
  postgres:
    image: postgres:16
  redis:
    image: redis:7

  # 可选模块（按License启用）
  collector: # SSH模块需要
    image: netvis/collector:${VERSION}
    profiles: ["collector"]
  alert-engine: # 高级告警模块
    image: netvis/alert:${VERSION}
    profiles: ["alert"]
  report-scheduler: # 报表模块
    image: netvis/report:${VERSION}
    profiles: ["report"]
```

#### 按模块启动

```bash
# 基础版：仅核心服务
docker-compose up -d

# 专业版：启用采集器和告警
docker-compose --profile collector --profile alert up -d

# 企业版：全部模块
docker-compose --profile collector --profile alert --profile report up -d
```

---

## 八、待确认事项

> [!IMPORTANT]
> 请老板确认后开始开发：

1. **技术架构**：Go+Bun 混合 可行？
2. **优先级**：Phase 顺序 OK？
3. **部署**：Docker Compose 足够？需要 K8s Helm Chart 吗？
4. **时间预期**：约 8-9 周交付 MVP 可接受？
5. **移动端**：企微集成优先 还是 Flutter App 优先？
6. **监控方案**：需要内置 Prometheus+Grafana 吗？
